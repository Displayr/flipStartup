context("Price sensitivity meter")

dat <- as.matrix(data.frame(`Too cheap` = c(1, 0.5, 0.75, 0.5, 0.25, 0.5, 0.5, 1, 1, 0.1,
                                            1, 0.5, 1, 0, 0.5, 0.25, 1, 2, 0.75, 0.25,
                                            0.75, 0.5, 0.75, 0.25, 1.5, 0.2),
                            `Cheap` = c(1, 2.1, 2, 2, 0.75, 2,0.5, 1.5, 4, 1.5,
                                        0.5, 3.5, 0.9, 2.5, 0.8, 3, 0.25, 5, 2.5, 1,
                                        1, 1, 1, 2, 1, 1),
                            'Expensive' = c(2, 2.8, 5, 2.5, 1.5, 4, 1.5, 2, 5.5, 3,
                                            1.7, 7, 2, 3.5, 1.1, 5, 1, 6, 3, 3,
                                            2, 1.5, 1.5, 3, 1.5, 2.5),
                            'Too expensive' = c(6, 2.5, 3, 2, 2, 3, 5, 3.5, 8, 1.5,
                                                6, 1.2, 4.5, 3, 8, 2, 3, 6, 2, 2,
                                                7, 5, 8, 7, 3, 5)))


test_that("PSM",
{
    expect_error(PriceSensitivityMeter(dat), NA)
    dat[5,1] <- NA
    dat[6,4] <- NA
    expect_error(PriceSensitivityMeter(dat), NA)
})

fake <- data.frame(A = 1:10, B = (1:10) + 1, C = (1:10) + 2, D = (1:10) + 3)
test_that("Check proportions",
{
    psm0 <- PriceSensitivityMeter(fake)
    expect_equal(attr(psm0, "ChartData")[,1], c((1:10)/10, 1.0, 1.0, 1.0), check.attributes = FALSE)
    psm1 <- PriceSensitivityMeter(fake, resolution = 0.1)
    expect_equal(attr(psm1, "ChartData")[,3], 
        c(`1` = 1, `1.1` = 1, `1.2` = 1, `1.3` = 1, `1.4` = 1, `1.5` = 1, 
        `1.6` = 1, `1.7` = 1, `1.8` = 1, `1.9` = 1, `2` = 1, `2.1` = 1, 
        `2.2` = 1, `2.3` = 1, `2.4` = 1, `2.5` = 1, `2.6` = 1, `2.7` = 1, 
        `2.8` = 1, `2.9` = 1, `3` = 1, `3.1` = 0.9, `3.2` = 0.9, `3.3` = 0.9, 
        `3.4` = 0.9, `3.5` = 0.9, `3.6` = 0.9, `3.7` = 0.9, `3.8` = 0.9, 
        `3.9` = 0.9, `4` = 0.9, `4.1` = 0.8, `4.2` = 0.8, `4.3` = 0.8, 
        `4.4` = 0.8, `4.5` = 0.8, `4.6` = 0.8, `4.7` = 0.8, `4.8` = 0.8, 
        `4.9` = 0.8, `5` = 0.8, `5.1` = 0.7, `5.2` = 0.7, `5.3` = 0.7, 
        `5.4` = 0.7, `5.5` = 0.7, `5.6` = 0.7, `5.7` = 0.7, `5.8` = 0.7, 
        `5.9` = 0.7, `6` = 0.7, `6.1` = 0.6, `6.2` = 0.6, `6.3` = 0.6, 
        `6.4` = 0.6, `6.5` = 0.6, `6.6` = 0.6, `6.7` = 0.6, `6.8` = 0.6, 
        `6.9` = 0.6, `7` = 0.6, `7.1` = 0.5, `7.2` = 0.5, `7.3` = 0.5, 
        `7.4` = 0.5, `7.5` = 0.5, `7.6` = 0.5, `7.7` = 0.5, `7.8` = 0.5, 
        `7.9` = 0.5, `8` = 0.5, `8.1` = 0.4, `8.2` = 0.4, `8.3` = 0.4, 
        `8.4` = 0.4, `8.5` = 0.4, `8.6` = 0.4, `8.7` = 0.4, `8.8` = 0.4, 
        `8.9` = 0.4, `9` = 0.4, `9.1` = 0.3, `9.2` = 0.3, `9.3` = 0.3, 
        `9.4` = 0.3, `9.5` = 0.3, `9.6` = 0.3, `9.7` = 0.3, `9.8` = 0.3, 
        `9.9` = 0.3, `10` = 0.3, `10.1` = 0.2, `10.2` = 0.2, `10.3` = 0.2, 
        `10.4` = 0.2, `10.5` = 0.2, `10.6` = 0.2, `10.7` = 0.2, `10.8` = 0.2, 
        `10.9` = 0.2, `11` = 0.2, `11.1` = 0.1, `11.2` = 0.1, `11.3` = 0.1, 
        `11.4` = 0.1, `11.5` = 0.1, `11.6` = 0.1, `11.7` = 0.1, `11.8` = 0.1, 
        `11.9` = 0.1, `12` = 0.1, `12.1` = 0, `12.2` = 0, `12.3` = 0, 
        `12.4` = 0, `12.5` = 0, `12.6` = 0, `12.7` = 0, `12.8` = 0, `12.9` = 0, 
        `13` = 0))
    psm2 <- PriceSensitivityMeter(fake, weights = 1:10)
    expect_equal(attr(psm2, "ChartData")[,2],
       c(`1` = 0, `2` = 0.0181818181818182, `3` = 0.0545454545454545, 
       `4` = 0.109090909090909, `5` = 0.181818181818182, `6` = 0.272727272727273, 
       `7` = 0.381818181818182, `8` = 0.509090909090909, `9` = 0.654545454545455, 
       `10` = 0.818181818181818, `11` = 1, `12` = 1, `13` = 1))
})
